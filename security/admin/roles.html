<div id="sidebar" class="sidebar">
    <ul id="uxSidebarUL">
        <li class="search-bar">
            <ul class="searcher">
                <li>
                    <input type="text" id="uxCriteria" searchcol="UserName" class="search" placeholder="جستجو (اسم رول)" />
                </li>
            </ul>
        </li>
    </ul>
</div>
<style type="text/css">
    .grid th {
        padding: 5px;
    }
    .create {
        display: none;
    }
</style>
<div class="div-form">
    <h2 class="title">فورم ثبت رول ها (حقوق )</h2>

    <div class="div-row">
        <label>حقوق (Role)</label>
        <div class="bind">
            <select id="uxRole" path="perm.Role" rule="{fn:'required'}" vgroup="A_" class="w300" />
            <img src="../../skin/icon/edit-50.png" style="margin: -7px 2px; cursor: pointer" id="uxEdit" title="Edit / ویرایسش" />
            <img src="../../skin/icon/plus-50.png" style="margin: -7px 2px; cursor: pointer" id="uxCreate" title="Add Role / علاوه کردن حقوق" />

            <span style="font-family: calibri; font-size: 11pt"> → فقط برای تغییرات در اسم رول و یا اضافه کردن رول جدید استفاده شود </span>
        </div>
        <div class="create">
            <input id="uxName" type="text" rule="{fn:'required'}" vgroup="s" class="w300" />
            <img src="../../skin/icon/save-50.png" style="margin: -7px 2px; cursor: pointer" id="uxSave" title="Save / ثبت" />
            <img src="../../skin/icon/cancel-50.png" style="margin: -7px 2px; cursor: pointer" id="uxCancel" title="Cancel / لغو" />
        </div>
    </div>
    <div class="div-form-control" style="border-top: 0; margin: 0; position: absolute; width: 90%;">
        <input type="submit" action="save" vgroup="A_" value="ثبت تغییرات" />
    </div>
    <h2>صلاحیت های رول در صفحات </h2>
    <div class="div-grid grid" style="height: 600px; max-height:calc( 100% - 260px );">
        <table id="dvRoleRight">
            <tbody></tbody>
        </table>
    </div>

</div>

<script type="text/javascript">
	//-------------------------------
	// uxRole dropdown (fetch, add, edit)
	//-------------------------------
    var Rights = {"": null};
    (function () {
        var _urlDeserialized = plus.page.prototype.deserialize();
        var screen = _urlDeserialized.path;

        plus.data.ajax({
            type: 'post',
            url: plus.config.baseUrl + "json/pull.asmx/Fetch", async: false
            , data: plus.json.write({
                queries: [{
                    path: 'perm.Role', screen: screen
                }, { path: 'look.vRight', screen: screen}
                ]
            })
            , success: function (msg) {
                var output = plus.json.read(msg);
                var table = output[0];
                var $combo = $('#uxRole');
                $combo.append('<option value="">' + ($combo.attr('emptyText') || "&nbsp;&nbsp;---") + '</option>');
                for (var j = 0; j < table.rows.length; j++) {
                    var row = table.rows[j];
                    $combo.append('<option value="' + row[0] + '">' + row[1] + '</option>');
                }
                table = output[1];
                for (var i = 0; i < table.rows.length; i++)
                    Rights[(i + 3) + ""] = table.rows[i][0];
            }
        });
    })();

	var action = 'I';
	$('#uxCreate').click(function () {
		$('.bind, .create').toggle();
		$('#uxRole').val('');
		action = 'I';
		$('.grid input:checkbox').prop('checked', false);
	});

    $('#uxEdit').click(function () {
        var id = $('#uxRole').val();
        if (!id) return plus.widget.error('لطفاً رول را انتخاب نمایید.');
        $('#uxName').val($('#uxRole option:selected').text());
        $('.bind, .create').toggle();
        action = 'U';
    });
    $('#uxCancel').click(function () {
        $('#uxName').val('');
        $('.bind, .create').toggle();
	});

	$('#uxSave').click(function () {
		var name = $('#uxName').val().trim();
		if (name.length < 1) {
			plus.widget.error('لطفاٌ اسم رول را مشخص سازید.');
			return;
		}
		var _param = { Name: $('#uxName').val() };
		if (action != 'I') _param["ID"] = $('#uxRole').val();
		plus.data.post({
			async: false, url: plus.config.baseUrl + 'json/push.asmx/save',
            data: plus.json.write({ query: { path: 'econfsys.perm.spSaveRole', commandType: 'sp', type: 'proc', values: _param, screen: plus.page.prototype.deserialize().path } }),
			success: function (msg) {
				var response = plus.json.read(msg);
				if ($.isArray(response)) response = response[0];
				if (response.error || response.ResponseType != "SUCCESS") {
					plus.widget.error(response.error || response.response);
					return false;
				}
				if (response.value) {
					if (action == 'I') {
						$('#uxRole').append('<option selected value="' + response.value + '">' + _param.Name + '</option>');
					}
					else $('#uxRole option[value="' + response.value + '"]').text(_param.Name);
					fnBuildStructure();
				}
				$('.bind, .create').toggle();
				action = 'U';
				plus.widget.success(response.response || 'معلومات موفقانه ثبت شد.');
			}
		});
	});


	///------------------------------------
	// Role Right Grid (Fetch, Add, Edit)
	//-------------------------------------

	$('#uxRole').change(fnBuildStructure);

    $('.div-form-control [action="save"]')
        .unbind('click')
        .bind('click', function () {
            var values = [];

            $('.grid tr').each(function (index) {
                if (index != 0) {
                    var def = [], changes = [], changed = { screenid:$(this).attr('dataid'), del: [], insert: [] };
                    eval("def=" + $(this).attr('def'));

                    $(this).find('input:checkbox:checked').each(function (i2) {
                        changes.push( ($(this).attr('index') -0) );
                    });
                    if (def.length || changes.length) {
                        def.sort();
                        changes.sort();
                        // get deleted
                        for (var i=0; i<def.length; i++) {
                            if (Array.indexOf(changes, def[i]) == -1)
                                changed.del.push(Rights[def[i] + ""]);
                        }
                        for (var i = 0; i < changes.length; i++)
                            if (Array.indexOf(def, changes[i]) == -1)
                                changed.insert.push(Rights[changes[i] + ""]);
                        if (changed.del.length || changed.insert.length)
                            values.push(changed);
                    }
                }
            });
            if (!values.length) {
                plus.widget.error("تغییرات در صلاحیت ها وارد نگردیده است.");
                return;
            }

            //return;
            plus.data.post({
                async: false, url: plus.config.baseUrl + 'json/push.asmx/saveRights'
                , data: plus.json.write({ query: { values: values, RoleID: $('#uxRole').val(), screen: plus.page.prototype.deserialize().path } }),
                success: function (msg) {
                    var response = plus.json.read(msg);
                    if ($.isArray(response)) response = response[0];
                    if (response.error || response.ResponseType != "SUCCESS") {
                        plus.widget.error(response.error || response.response);
                        return false;
                    }
                    plus.widget.success(response.response || 'معلومات موفقانه ثبت شد.');
                    fnBuildStructure( $('.grid').scrollTop() );
                }
            });
        });

    function fnBuildStructure (scroll) {
        var _roleID = $('#uxRole').val();
        if (!_roleID) _roleID = -1;
        if (_roleID == -1 && $('#dveconfsys_perm_spGetRoleStructure tr').size()) {
            // uncheck all
            $('.grid tr img').attr('src', '../../skin/icon/checked_false-32.png');
            return;
        }
        $('.grid tr').remove();
        plus.data.ajax({
            type: 'post',
            url: plus.config.baseUrl + "json/pull.asmx/Fetch", async: false
            , data: plus.json.write({
                queries: [{
                    path: 'perm.spGetRoleStructure', fetchColumns: true
                    , commandType: 'sp', param: { RoleID: _roleID }
                    , screen: plus.page.prototype.deserialize().path
                }]
            })
            , success: function (msg) {
                var output = plus.json.read(msg);
                if (!output.length) return;
                output = output[0];
                var grid = $('#dvRoleRight tbody');

                var header = $('<tr></tr>').appendTo(grid);
                //var indexes = { id: 0 }, templ = '<tr class="grid-row">'

                for (var i = 0; i < output.columns.length; i++) {
                    var column = output.columns[i];
                    if (column == "ID") continue;
                    //indexes[column] = i;
                    //if (i > 2) templ += '<td style="width:50px"><input type="checkbox" disabled checked="{' + column + '}" /></td>';
                    //else templ += '<td style="width:200px">{' + column + '}</td>';
                    $('<th style="' + (i > 2 ? "width:50px; text-align:center;" : "width:200px") + '">' + column + '</th>').appendTo(header);
                }
                //templ += '</tr>';
                var sb = [], rows = output.rows;
                for (var j = 0; j < rows.length; j++) {
                    var row = rows[j];
                    var sb2 = [], def = [];
                    sb2.push('<tr def="[]" class="grid-row" dataid="' + row[0] + '">');
                    for (var i = 0; i < output.columns.length; i++) {
                        var column = output.columns[i], v = row[i];

                        if (column == "ID") continue;
                        if (i>2 && v != "0") def.push(i);
                        //if (i > 2) sb.push('<td style="text-align:center; width:50px;"><img style="width:20px;float:none;" src="../../skin/icon/' + (v == "0" ? "checked_false" : "checked_true") + '-32.png" /></td>');
						//if (i == 8)
						//	sb2.push('<td style="text-align:center; width:50px;"><select path="econfsys.pol.accessibility"/></td>');
						//else
                        if (i > 2) sb2.push('<td style="text-align:center; width:50px;"><input type="checkbox" index="' + i + '" ' + (v == "0" ? '' : 'checked="checked"') + ' /></td>');
						else sb2.push('<td style="width:200px">' + v + '</td>');
                    }
                    sb2.push("</tr>");

                    sb.push(sb2.join("").replace('def="[]"', ('def="[' + def.join(",") + ']"')));
                }
                grid.append(sb.join(""));
                if (scroll) $('.grid').scrollTop(scroll);
            }
        });
    }
    //fnBuildStructure();
</script>